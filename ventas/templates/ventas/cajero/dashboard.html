{# ventas/templates/ventas/cajero/dashboard.html #}
{% extends "base.html" %}
{% load static %}
{% block title %}Registrar Venta{% endblock %}

{% block content %}
<div class="container py-4">

  {# — Mensajes de Django — #}
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
      </div>
    {% endfor %}
  {% endif %}

  <h1 class="mb-4 text-warning">Registrar Venta</h1>

  {# — BUSCADOR CON AUTOCOMPLETE — #}
  <div class="position-relative mb-3">
    <input type="text"
           id="input-busqueda"
           name="busqueda"
           class="form-control"
           placeholder="Buscar producto..."
           autocomplete="off"
           value="{{ termino_busqueda }}">
    <ul id="sugerencias"
        class="list-group position-absolute w-100"
        style="z-index:1000; max-height:200px; overflow-y:auto; display:none;">
    </ul>
  </div>

  {# — AGREGAR AL CARRITO — #}
  <form method="post" class="mb-3">
    {% csrf_token %}
    <div class="row g-2">
      <div class="col-md-6">
        <select name="producto_id" class="form-select" id="select-producto">
          {% for p in productos %}
            <option value="{{ p.id }}" data-stock="{{ p.stock_disponible }}">
              {{ p.nombre }} – ${{ p.precio }} (Stock: {{ p.stock_disponible }})
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <input type="number"
               name="cantidad"
               class="form-control"
               id="input-cantidad"
               value="1"
               min="1"
               required>
      </div>
      <div class="col-md-3">
        <button type="submit"
                name="agregar"
                class="btn btn-success w-100">
          Agregar al carrito
        </button>
      </div>
    </div>
  </form>

  {# — CARRITO DE COMPRAS — #}
  <div class="card mb-4">
    <div class="card-header">Carrito de Compras</div>
    <div class="card-body">
      {% if carrito_items %}
        <table class="table">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Subtotal</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for item in carrito_items %}
            <tr>
              <td>{{ item.producto.nombre }}</td>
              <td>{{ item.cantidad }}</td>
              <td>${{ item.subtotal }}</td>
              <td>
                <form method="post" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit"
                          name="eliminar"
                          value="{{ item.producto.id }}"
                          class="btn btn-danger btn-sm">
                    Quitar
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              <th colspan="2">Total</th>
              <th>${{ total }}</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      {% else %}
        <p class="text-center text-muted">Carrito vacío</p>
      {% endif %}
    </div>
  </div>

  {# — MEDIO DE PAGO Y FINALIZAR — #}
  <form method="post">
    {% csrf_token %}
    <div class="row g-2 mb-4">
      <div class="col-md-4">
        <select name="medio_pago" class="form-select" required>
          <option value="">Seleccionar medio de pago</option>
          <option value="Crédito">Tarjeta Crédito</option>
          <option value="Débito">Tarjeta Débito</option>
          <option value="Efectivo">Efectivo</option>
        </select>
      </div>
      <div class="col-md-8">
        <button type="submit"
                name="finalizar"
                class="btn btn-warning w-100">
          Finalizar Venta
        </button>
      </div>
    </div>
  </form>
</div>

{# — JAVASCRIPT: datos + autocomplete + límite de stock — #}
<script>
// 1) Array de productos para autocomplete
const productos = JSON.parse(document.getElementById('productos-data').textContent);

// 2) Referencias al DOM
const inputBusqueda   = document.getElementById('input-busqueda');
const sugerencias     = document.getElementById('sugerencias');
const selectProducto  = document.getElementById('select-producto');
const inputCantidad   = document.getElementById('input-cantidad');

// 3) Crear mapa producto_id → stock disponible
const stockMap = {};
document.querySelectorAll('#select-producto option').forEach(opt => {
  stockMap[opt.value] = parseInt(opt.dataset.stock);
});

// 4) Función para actualizar el máximo del input de cantidad
function actualizarMax() {
  const prodId   = selectProducto.value;
  const maxStock = stockMap[prodId] || 1;
  inputCantidad.max = maxStock;
  if (+inputCantidad.value > maxStock) {
    inputCantidad.value = maxStock;
  }
}

// 5) Autocomplete: mostrar, filtrar y seleccionar
inputBusqueda.addEventListener('focus', () => {
  if (sugerencias.children.length) sugerencias.style.display = 'block';
});
inputBusqueda.addEventListener('blur', () => {
  setTimeout(() => sugerencias.style.display = 'none', 100);
});
inputBusqueda.addEventListener('input', e => {
  const term = e.target.value.toLowerCase();
  const matches = productos.filter(p =>
    p.nombre.toLowerCase().includes(term)
  );
  sugerencias.innerHTML = matches.map(p => `
    <li class="list-group-item list-group-item-action"
        data-id="${p.id}"
        data-nombre="${p.nombre}">
      ${p.nombre}
    </li>
  `).join('');
  sugerencias.style.display = matches.length ? 'block' : 'none';
  // Al hacer clic en una sugerencia
  sugerencias.querySelectorAll('li').forEach(li =>
    li.addEventListener('mousedown', () => {
      inputBusqueda.value   = li.dataset.nombre;
      selectProducto.value  = li.dataset.id;
      actualizarMax();
      sugerencias.style.display = 'none';
    })
  );
});

// 6) Ejecutar al cargar y al cambiar selección
window.addEventListener('DOMContentLoaded', actualizarMax);
selectProducto.addEventListener('change', actualizarMax);
</script>
{% endblock %}
